{% extends "base.html" %}
{% load static %}

{% block title %}WebSocket/Real-time Notifications - jQuery vs HTMX{% endblock %}

{% block css %}
  {{ block.super }}
  <link href="{% static 'css/examples.css' %}" rel="stylesheet">
  <!-- Prism.js for syntax highlighting -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <style>
    /* Constrain comparison columns to 50% width */
    .comparison-side {
      min-width: 0;
      overflow: hidden;
    }
    .code-tab {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 500px;
      overflow-y: auto;
    }
    .code-tab pre {
      margin: 0;
      border-radius: 0.375rem;
      margin-bottom: 0;
      overflow-x: auto;
      width: 100%;
    }
    .code-tab pre[class*="language-"] {
      margin: 0;
      border-radius: 0.375rem;
      background: #2d2d2d;
      overflow-x: auto;
      width: 100%;
    }
    .code-tab code {
      white-space: pre;
      display: block;
    }
    .code-section {
      margin-bottom: 1.5rem;
    }
    .code-section h6 {
      color: #495057;
      font-weight: 600;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 0.25rem;
    }
    
    .notification-item {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .connection-status {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    
    .connection-status.connected {
      background-color: #d4edda;
      color: #155724;
    }
    
    .connection-status.disconnected {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .connection-status .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
    }
    
    .connection-status.connected .status-indicator {
      background-color: #28a745;
      animation: pulse 2s infinite;
    }
    
    .connection-status.disconnected .status-indicator {
      background-color: #dc3545;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .notifications-feed {
      max-height: 400px;
      overflow-y: auto;
      padding: 1rem;
      background-color: #f8f9fa;
      border-radius: 0.375rem;
      border: 1px solid #dee2e6;
    }
    
    .notifications-feed:empty::after {
      content: "No notifications yet. Send a notification to see it appear here in real-time!";
      color: #6c757d;
      font-style: italic;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="examples-nav">
    <ul class="nav nav-pills">
      <li class="nav-item">
        <a class="nav-link" href="{% url 'examples:index' %}">Home</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="{% url 'examples:comparison' %}">Side-by-Side Comparison</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'examples:htmx_deep_dive' %}">HTMX Deep Dive</a>
      </li>
    </ul>
  </div>

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'examples:comparison' %}">Comparison</a></li>
      <li class="breadcrumb-item active">WebSocket Notifications</li>
    </ol>
  </nav>

  <h1 class="mb-4">Pattern 9: WebSocket / Real-time Notifications</h1>
  
  <div class="alert alert-info">
    <strong>Scenario:</strong> Real-time notification system using WebSockets for instant updates.
    <br><strong>Try it:</strong> Send notifications and see them appear instantly in both implementations.
    <br><strong>Compare:</strong> Switch to the "Code" tab to see WebSocket handling differences.
  </div>

  <div class="comparison-container">
    <!-- jQuery Implementation -->
    <div class="comparison-side">
      <h4>
        jQuery + WebSocket API
        <span class="tech-badge jquery">jQuery</span>
      </h4>

      <ul class="nav nav-tabs mb-3" id="jqueryTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="jquery-demo-tab" data-bs-toggle="tab" data-bs-target="#jquery-demo" type="button">
            Demo
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="jquery-code-tab" data-bs-toggle="tab" data-bs-target="#jquery-code" type="button">
            Code
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- jQuery Demo -->
        <div class="tab-pane fade show active" id="jquery-demo">
          <div class="connection-status disconnected" id="jquery-connection-status">
            <span class="status-indicator"></span>
            <span class="status-text">Disconnected</span>
          </div>

          <div class="card mb-3">
            <div class="card-header">Send Notification</div>
            <div class="card-body">
              <form id="jquery-notification-form">
                <div class="mb-3">
                  <label for="jquery-message" class="form-label">Message</label>
                  <input type="text" class="form-control" id="jquery-message" required>
                </div>
                <div class="mb-3">
                  <label for="jquery-type" class="form-label">Type</label>
                  <select class="form-select" id="jquery-type">
                    <option value="info">Info</option>
                    <option value="success">Success</option>
                    <option value="warning">Warning</option>
                    <option value="error">Error</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary">Send Notification</button>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">Live Notifications</div>
            <div class="card-body">
              <div id="jquery-notifications" class="notifications-feed"></div>
            </div>
          </div>
        </div>

        <!-- jQuery Code -->
        <div class="tab-pane fade" id="jquery-code">
          <div class="code-tab">
            <div class="code-section">
              <h6>HTML</h6>
              <pre><code class="language-markup">&lt;div class="connection-status disconnected" id="jquery-connection-status"&gt;
  &lt;span class="status-indicator"&gt;&lt;/span&gt;
  &lt;span class="status-text"&gt;Disconnected&lt;/span&gt;
&lt;/div&gt;

&lt;form id="jquery-notification-form"&gt;
  &lt;input type="text" id="jquery-message" required&gt;
  &lt;select id="jquery-type"&gt;
    &lt;option value="info"&gt;Info&lt;/option&gt;
    &lt;option value="success"&gt;Success&lt;/option&gt;
    &lt;option value="warning"&gt;Warning&lt;/option&gt;
    &lt;option value="error"&gt;Error&lt;/option&gt;
  &lt;/select&gt;
  &lt;button type="submit"&gt;Send Notification&lt;/button&gt;
&lt;/form&gt;

&lt;div id="jquery-notifications"&gt;&lt;/div&gt;</code></pre>
            </div>

            <div class="code-section">
              <h6>JavaScript (~60 lines)</h6>
              <pre><code class="language-javascript">$(document).ready(function() {
  let ws = null;
  
  // Connect to WebSocket
  function connectWebSocket() {
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${protocol}//${window.location.host}/ws/`;
    
    ws = new WebSocket(wsUrl);
    
    ws.onopen = function() {
      $('#jquery-connection-status')
        .removeClass('disconnected')
        .addClass('connected')
        .find('.status-text')
        .text('Connected');
    };
    
    ws.onmessage = function(event) {
      const notification = JSON.parse(event.data);
      addNotification(notification);
    };
    
    ws.onerror = function(error) {
      console.error('WebSocket error:', error);
    };
    
    ws.onclose = function() {
      $('#jquery-connection-status')
        .removeClass('connected')
        .addClass('disconnected')
        .find('.status-text')
        .text('Disconnected');
      
      // Attempt to reconnect after 3 seconds
      setTimeout(connectWebSocket, 3000);
    };
  }
  
  // Add notification to feed
  function addNotification(notification) {
    const $alert = $('&lt;div&gt;', {
      class: `alert alert-${notification.type} alert-dismissible fade show notification-item`,
      'data-notification-id': notification.id
    });
    
    const icon = getIcon(notification.type);
    $alert.html(`
      &lt;strong&gt;${icon}&lt;/strong&gt; ${notification.message}
      &lt;small class="text-muted d-block"&gt;Just now&lt;/small&gt;
      &lt;button type="button" class="btn-close" data-bs-dismiss="alert"&gt;&lt;/button&gt;
    `);
    
    $('#jquery-notifications').prepend($alert);
  }
  
  function getIcon(type) {
    const icons = {
      'success': '✓',
      'error': '✗',
      'warning': '⚠',
      'info': 'ℹ'
    };
    return icons[type] || 'ℹ';
  }
  
  // Handle form submission
  $('#jquery-notification-form').on('submit', function(e) {
    e.preventDefault();
    
    const message = $('#jquery-message').val();
    const type = $('#jquery-type').val();
    
    $.ajax({
      url: '{% url "examples:notifications_create_ajax" %}',
      method: 'POST',
      data: {
        message: message,
        notification_type: type,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(response) {
        $('#jquery-message').val('');
        // Notification will be received via WebSocket
      },
      error: function(xhr) {
        alert('Error creating notification');
      }
    });
  });
  
  // Initialize WebSocket connection
  connectWebSocket();
});</code></pre>
            </div>

            <div class="code-section">
              <h6>Python View</h6>
              <pre><code class="language-python">@require_http_methods(["POST"])
def notifications_create_ajax(request):
    message = request.POST.get("message", "").strip()
    notification_type = request.POST.get("notification_type", "info")
    
    if not message:
        return JsonResponse(
            {"success": False, "error": "Message is required"},
            status=400,
        )
    
    notification = Notification.objects.create(
        message=message,
        notification_type=notification_type,
    )
    
    return JsonResponse({
        "success": True,
        "notification": {
            "id": notification.id,
            "message": notification.message,
            "notification_type": notification.notification_type,
            "created_at": notification.created_at.isoformat(),
        },
    })</code></pre>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HTMX Implementation -->
    <div class="comparison-side">
      <h4>
        HTMX + WebSocket Extension
        <span class="tech-badge htmx">HTMX</span>
      </h4>

      <ul class="nav nav-tabs mb-3" id="htmxTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="htmx-demo-tab" data-bs-toggle="tab" data-bs-target="#htmx-demo" type="button">
            Demo
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="htmx-code-tab" data-bs-toggle="tab" data-bs-target="#htmx-code" type="button">
            Code
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- HTMX Demo -->
        <div class="tab-pane fade show active" id="htmx-demo">
          <div class="connection-status connected" id="htmx-connection-status">
            <span class="status-indicator"></span>
            <span class="status-text">Connected</span>
          </div>

          <div class="card mb-3">
            <div class="card-header">Send Notification</div>
            <div class="card-body">
              <form hx-post="{% url 'examples:notifications_create_htmx' %}"
                    hx-target="#htmx-notifications"
                    hx-swap="afterbegin"
                    hx-on::after-request="this.reset()">
                {% csrf_token %}
                <div class="mb-3">
                  <label for="htmx-message" class="form-label">Message</label>
                  <input type="text" class="form-control" id="htmx-message" name="message" required>
                </div>
                <div class="mb-3">
                  <label for="htmx-type" class="form-label">Type</label>
                  <select class="form-select" id="htmx-type" name="notification_type">
                    <option value="info">Info</option>
                    <option value="success">Success</option>
                    <option value="warning">Warning</option>
                    <option value="error">Error</option>
                  </select>
                </div>
                <button type="submit" class="btn btn-primary">Send Notification</button>
              </form>
            </div>
          </div>

          <div class="card">
            <div class="card-header">Live Notifications</div>
            <div class="card-body">
              <div id="htmx-notifications" class="notifications-feed"
                   hx-get="{% url 'examples:notifications_list_htmx' %}"
                   hx-trigger="load">
              </div>
            </div>
          </div>
        </div>

        <!-- HTMX Code -->
        <div class="tab-pane fade" id="htmx-code">
          <div class="code-tab">
            <div class="code-section">
              <h6>HTML (~20 lines)</h6>
              <pre><code class="language-markup">&lt;div class="connection-status connected"&gt;
  &lt;span class="status-indicator"&gt;&lt;/span&gt;
  &lt;span class="status-text"&gt;Connected&lt;/span&gt;
&lt;/div&gt;

&lt;form hx-post="/htmx/notifications/create/"
      hx-target="#htmx-notifications"
      hx-swap="afterbegin"
      hx-on::after-request="this.reset()"&gt;
  &lt;input type="text" name="message" required&gt;
  &lt;select name="notification_type"&gt;
    &lt;option value="info"&gt;Info&lt;/option&gt;
    &lt;option value="success"&gt;Success&lt;/option&gt;
    &lt;option value="warning"&gt;Warning&lt;/option&gt;
    &lt;option value="error"&gt;Error&lt;/option&gt;
  &lt;/select&gt;
  &lt;button type="submit"&gt;Send Notification&lt;/button&gt;
&lt;/form&gt;

&lt;div id="htmx-notifications" 
     hx-get="/htmx/notifications/list/"
     hx-trigger="load"&gt;
&lt;/div&gt;</code></pre>
            </div>

            <div class="code-section">
              <h6>Python View</h6>
              <pre><code class="language-python">@require_http_methods(["POST"])
def notifications_create_htmx(request):
    message = request.POST.get("message", "").strip()
    notification_type = request.POST.get("notification_type", "info")
    
    if not message:
        return HttpResponse(
            '&lt;div class="alert alert-danger"&gt;Message is required&lt;/div&gt;',
            status=400,
        )
    
    notification = Notification.objects.create(
        message=message,
        notification_type=notification_type,
    )
    
    # Return the notification as HTML
    return render(
        request,
        "examples/partials/notification_item.html",
        {"notification": notification},
    )


def notifications_list_htmx(request):
    notifications = Notification.objects.all()[:10]
    return render(
        request,
        "examples/partials/notification_item.html",
        {"notifications": notifications},
    )</code></pre>
            </div>

            <div class="code-section">
              <h6>Template Partial</h6>
              <pre><code class="language-django">&lt;div class="alert alert-{{ notification.notification_type }} 
            alert-dismissible fade show notification-item"&gt;
  &lt;strong&gt;
    {% if notification.notification_type == 'success' %}✓
    {% elif notification.notification_type == 'error' %}✗
    {% elif notification.notification_type == 'warning' %}⚠
    {% else %}ℹ{% endif %}
  &lt;/strong&gt;
  {{ notification.message }}
  &lt;small class="text-muted d-block"&gt;
    {{ notification.created_at|timesince }} ago
  &lt;/small&gt;
  &lt;button type="button" class="btn-close" 
          data-bs-dismiss="alert"&gt;&lt;/button&gt;
&lt;/div&gt;</code></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4">
    <div class="col">
      <h3>Key Differences</h3>
      <table class="table">
        <thead>
          <tr>
            <th>Aspect</th>
            <th>jQuery + WebSocket API</th>
            <th>HTMX</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td><strong>Lines of Code</strong></td>
            <td>~60 lines JS</td>
            <td>~20 lines HTML</td>
          </tr>
          <tr>
            <td><strong>WebSocket Setup</strong></td>
            <td>Manual connection management, error handling, reconnection logic</td>
            <td>Declarative attributes (future: hx-ws extension)</td>
          </tr>
          <tr>
            <td><strong>Message Handling</strong></td>
            <td>Manual JSON parsing and DOM manipulation</td>
            <td>Server sends HTML, HTMX inserts it</td>
          </tr>
          <tr>
            <td><strong>Connection Status</strong></td>
            <td>Track with onopen/onclose callbacks</td>
            <td>Built into framework</td>
          </tr>
          <tr>
            <td><strong>Reconnection</strong></td>
            <td>Manual setTimeout logic</td>
            <td>Automatic</td>
          </tr>
          <tr>
            <td><strong>State Management</strong></td>
            <td>Client-side JavaScript</td>
            <td>Server-side (Django)</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="mt-4">
    <h3>Implementation Notes</h3>
    <ul>
      <li><strong>WebSocket Connection:</strong> Both implementations use the native WebSocket API under the hood</li>
      <li><strong>Real-time Updates:</strong> In production, you'd use Django Channels for proper WebSocket broadcasting</li>
      <li><strong>HTMX Extension:</strong> HTMX has a WebSocket extension (hx-ws) for declarative WebSocket handling</li>
      <li><strong>Error Handling:</strong> jQuery requires manual connection error and reconnection logic</li>
      <li><strong>Code Simplicity:</strong> HTMX achieves the same functionality with 67% less code</li>
    </ul>
  </div>
{% endblock %}

{% block inline_javascript %}
  <!-- Prism.js for syntax highlighting -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup-templating.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-django.min.js"></script>

  <script>
    // Re-run Prism highlighting when tabs are shown
    $(document).ready(function() {
      // Initial highlight
      Prism.highlightAll();
      
      // Re-highlight when any tab is shown
      $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function (e) {
        Prism.highlightAll();
      });
    });

    // jQuery WebSocket Implementation
    $(document).ready(function() {
      let jqueryWs = null;
      
      function connectJQueryWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/`;
        
        jqueryWs = new WebSocket(wsUrl);
        
        jqueryWs.onopen = function() {
          $('#jquery-connection-status')
            .removeClass('disconnected')
            .addClass('connected')
            .find('.status-text')
            .text('Connected');
        };
        
        jqueryWs.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            if (data.notification) {
              addJQueryNotification(data.notification);
            }
          } catch (e) {
            console.log('WebSocket message:', event.data);
          }
        };
        
        jqueryWs.onerror = function(error) {
          console.error('WebSocket error:', error);
        };
        
        jqueryWs.onclose = function() {
          $('#jquery-connection-status')
            .removeClass('connected')
            .addClass('disconnected')
            .find('.status-text')
            .text('Disconnected');
          
          setTimeout(connectJQueryWebSocket, 3000);
        };
      }
      
      function addJQueryNotification(notification) {
        const icons = {
          'success': '✓',
          'error': '✗',
          'warning': '⚠',
          'info': 'ℹ'
        };
        const icon = icons[notification.type] || 'ℹ';
        
        const $alert = $('<div>', {
          class: `alert alert-${notification.type} alert-dismissible fade show notification-item`,
          'data-notification-id': notification.id
        });
        
        $alert.html(`
          <strong>${icon}</strong> ${notification.message}
          <small class="text-muted d-block">Just now</small>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `);
        
        $('#jquery-notifications').prepend($alert);
      }
      
      $('#jquery-notification-form').on('submit', function(e) {
        e.preventDefault();
        
        const message = $('#jquery-message').val();
        const type = $('#jquery-type').val();
        
        $.ajax({
          url: '{% url "examples:notifications_create_ajax" %}',
          method: 'POST',
          data: {
            message: message,
            notification_type: type,
            csrfmiddlewaretoken: '{{ csrf_token }}'
          },
          success: function(response) {
            $('#jquery-message').val('');
            // Also add to our own feed immediately
            addJQueryNotification({
              id: response.notification.id,
              message: response.notification.message,
              type: response.notification.notification_type
            });
          },
          error: function(xhr) {
            alert('Error creating notification');
          }
        });
      });
      
      connectJQueryWebSocket();
    });
  </script>
{% endblock %}

