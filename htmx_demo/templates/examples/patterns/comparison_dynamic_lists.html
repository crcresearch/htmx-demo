{% extends "base.html" %}
{% load static %}

{% block title %}Dynamic Lists - jQuery vs HTMX{% endblock %}

{% block css %}
  {{ block.super }}
  <link href="{% static 'css/examples.css' %}" rel="stylesheet">
  <!-- Prism.js for syntax highlighting -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <style>
    /* Constrain comparison columns to 50% width */
    .comparison-side {
      min-width: 0;
      overflow: hidden;
    }
    .code-tab {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 500px;
      overflow-y: auto;
    }
    .code-tab pre {
      margin: 0;
      border-radius: 0.375rem;
      margin-bottom: 0;
      overflow-x: auto;
      width: 100%;
    }
    .code-tab pre[class*="language-"] {
      margin: 0;
      border-radius: 0.375rem;
      background: #2d2d2d;
      overflow-x: auto;
      width: 100%;
    }
    .code-tab code {
      white-space: pre;
      display: block;
    }
    .code-section {
      margin-bottom: 1.5rem;
    }
    .code-section h6 {
      color: #495057;
      font-weight: 600;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 0.25rem;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="examples-nav">
    <ul class="nav nav-pills">
      <li class="nav-item">
        <a class="nav-link" href="{% url 'examples:index' %}">Home</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="{% url 'examples:comparison' %}">Side-by-Side Comparison</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'examples:htmx_deep_dive' %}">HTMX Deep Dive</a>
      </li>
    </ul>
  </div>

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'examples:comparison' %}">Comparison</a></li>
      <li class="breadcrumb-item active">Dynamic Lists</li>
    </ol>
  </nav>

  <h1 class="mb-4">Pattern 5: Dynamic List Operations (Todo List)</h1>
  
  <div class="alert alert-info">
    <strong>Scenario:</strong> Add, remove, and toggle tasks dynamically.
    <br><strong>Try it:</strong> Add tasks, toggle completion, and delete items to see CRUD operations in action.
    <br><strong>Compare:</strong> Switch to the "Code" tab to see implementation differences.
  </div>

  <div class="comparison-container">
    <!-- jQuery Implementation -->
    <div class="comparison-side">
      <h4>
        jQuery/AJAX
        <span class="tech-badge jquery">jQuery</span>
      </h4>

      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#jquery-interface" type="button">
            Interface
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#jquery-code" type="button">
            Code
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- jQuery Interface Tab -->
        <div class="tab-pane fade show active" id="jquery-interface">
          <div class="mt-3">
            <form id="jquery-task-form" class="mb-3">
              {% csrf_token %}
              <div class="input-group">
                <input type="text" class="form-control" id="jquery-task-input" placeholder="New task...">
                <button type="submit" class="btn btn-primary">Add</button>
              </div>
            </form>
            <div id="jquery-task-list"></div>
          </div>
        </div>

        <!-- jQuery Code Tab -->
        <div class="tab-pane fade" id="jquery-code">
          <div class="code-tab">
            <div class="code-section">
              <h6>HTML Template</h6>
              <pre><code class="language-markup">&lt;form id="jquery-task-form"&gt;
  &lt;div class="input-group"&gt;
    &lt;input type="text" id="jquery-task-input" placeholder="New task..."&gt;
    &lt;button type="submit" class="btn btn-primary"&gt;Add&lt;/button&gt;
  &lt;/div&gt;
&lt;/form&gt;

&lt;div id="jquery-task-list"&gt;&lt;/div&gt;

&lt;!-- Task items will be dynamically created in JavaScript --&gt;</code></pre>
            </div>

            <div class="code-section">
              <h6>JavaScript (jQuery)</h6>
              <pre><code class="language-javascript">// Handle form submission
$('#jquery-task-form').on('submit', function(e) {
  e.preventDefault();
  const title = $('#jquery-task-input').val();
  
  if (!title) return;
  
  // AJAX request to create task
  $.ajax({
    url: '/examples/api/tasks/create/',
    method: 'POST',
    data: { title: title },
    headers: {'X-CSRFToken': csrftoken},
    success: function(response) {
      const task = response.task;
      
      // Manually build HTML for new task
      const html = 
        '&lt;div class="task-item" data-task-id="' + task.id + '"&gt;' +
          '&lt;input type="checkbox" class="form-check-input task-checkbox" ' + 
          (task.completed ? 'checked' : '') + '&gt;' +
          '&lt;div class="task-title"&gt;' + task.title + '&lt;/div&gt;' +
          '&lt;button class="btn btn-sm btn-danger task-delete"&gt;Delete&lt;/button&gt;' +
        '&lt;/div&gt;';
      
      // Prepend to list
      $('#jquery-task-list').prepend(html);
      $('#jquery-task-input').val('');
    }
  });
});

// Event delegation for delete button (works on dynamic elements)
$('#jquery-task-list').on('click', '.task-delete', function() {
  const taskItem = $(this).closest('.task-item');
  const taskId = taskItem.data('task-id');
  
  $.ajax({
    url: '/examples/api/tasks/' + taskId + '/delete/',
    method: 'DELETE',
    headers: {'X-CSRFToken': csrftoken},
    success: function() {
      taskItem.remove();  // Manual DOM removal
    }
  });
});

// Event delegation for checkbox toggle
$('#jquery-task-list').on('change', '.task-checkbox', function() {
  const taskItem = $(this).closest('.task-item');
  const taskId = taskItem.data('task-id');
  
  $.ajax({
    url: '/examples/api/tasks/' + taskId + '/toggle/',
    method: 'POST',
    headers: {'X-CSRFToken': csrftoken},
    success: function(response) {
      // Manually update CSS class
      if (response.task.completed) {
        taskItem.addClass('completed');
      } else {
        taskItem.removeClass('completed');
      }
    }
  });
});

// Key challenges:
// 1. Event delegation required for dynamic elements
// 2. Manual HTML string building
// 3. Multiple separate event handlers
// 4. Manual DOM manipulation for all changes</code></pre>
            </div>

            <div class="code-section">
              <h6>Django Views (Python)</h6>
              <pre><code class="language-python">@require_http_methods(["POST"])
def task_create_ajax(request):
    """AJAX endpoint - returns JSON."""
    title = request.POST.get("title", "").strip()
    
    task = Task.objects.create(title=title, completed=False)
    
    return JsonResponse({
        "task": {
            "id": task.id,
            "title": task.title,
            "completed": task.completed,
        }
    })

@require_http_methods(["DELETE"])
def task_delete_ajax(request, task_id):
    """Delete task - returns JSON status."""
    task = get_object_or_404(Task, id=task_id)
    task.delete()
    return JsonResponse({"success": True})

@require_http_methods(["POST"])
def task_toggle_ajax(request, task_id):
    """Toggle task completion - returns JSON."""
    task = get_object_or_404(Task, id=task_id)
    task.completed = not task.completed
    task.save()
    return JsonResponse({"task": {"completed": task.completed}})</code></pre>
            </div>

            <div class="alert alert-warning">
              <strong>Total Lines:</strong> ~10 lines (HTML) + ~60 lines (JS) = <strong>~70 lines</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HTMX Implementation -->
    <div class="comparison-side">
      <h4>
        HTMX
        <span class="tech-badge htmx">HTMX</span>
      </h4>

      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#htmx-interface" type="button">
            Interface
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#htmx-code" type="button">
            Code
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- HTMX Interface Tab -->
        <div class="tab-pane fade show active" id="htmx-interface">
          <div class="mt-3">
            <form hx-post="{% url 'examples:task_create_htmx' %}"
                  hx-target="#htmx-task-list"
                  hx-swap="afterbegin"
                  hx-on::after-request="if(event.detail.successful) this.reset()"
                  class="mb-3">
              {% csrf_token %}
              <div class="input-group">
                <input type="text" class="form-control" name="title" placeholder="New task..." required>
                <button type="submit" class="btn btn-primary">Add</button>
              </div>
            </form>
            <div id="htmx-task-list"></div>
          </div>
        </div>

        <!-- HTMX Code Tab -->
        <div class="tab-pane fade" id="htmx-code">
          <div class="code-tab">
            <div class="code-section">
              <h6>HTML Template (with HTMX attributes)</h6>
              <pre><code class="language-markup">&lt;form hx-post="{% templatetag openblock %} url 'examples:task_create_htmx' {% templatetag closeblock %}"
      hx-target="#htmx-task-list"
      hx-swap="afterbegin"
      hx-on::after-request="if(event.detail.successful) this.reset()"&gt;
  {% templatetag openblock %} csrf_token {% templatetag closeblock %}
  &lt;div class="input-group"&gt;
    &lt;input type="text" name="title" placeholder="New task..." required&gt;
    &lt;button type="submit" class="btn btn-primary"&gt;Add&lt;/button&gt;
  &lt;/div&gt;
&lt;/form&gt;

&lt;div id="htmx-task-list"&gt;&lt;/div&gt;

&lt;!-- Server returns HTML fragments to insert here --&gt;</code></pre>
            </div>

            <div class="code-section">
              <h6>Server Response (Partial Template)</h6>
              <pre><code class="language-markup">&lt;!-- task_item.html - Returned by server for each task --&gt;
&lt;div class="task-item"&gt;
  &lt;input type="checkbox" 
         class="form-check-input"
         hx-post="{% templatetag openblock %} url 'examples:task_toggle_htmx' task.id {% templatetag closeblock %}"
         hx-target="closest .task-item"
         hx-swap="outerHTML"
         {% templatetag openblock %} if task.completed {% templatetag closeblock %}checked{% templatetag openblock %} endif {% templatetag closeblock %}&gt;
  
  &lt;div class="task-title {% templatetag openblock %} if task.completed {% templatetag closeblock %}text-decoration-line-through{% templatetag openblock %} endif {% templatetag closeblock %}"&gt;
    {% templatetag openvariable %} task.title {% templatetag closevariable %}
  &lt;/div&gt;
  
  &lt;button class="btn btn-sm btn-danger"
          hx-delete="{% templatetag openblock %} url 'examples:task_delete_htmx' task.id {% templatetag closeblock %}"
          hx-target="closest .task-item"
          hx-swap="outerHTML swap:1s"&gt;
    Delete
  &lt;/button&gt;
&lt;/div&gt;

&lt;!-- Each task controls its own behavior! --&gt;
&lt;!-- No JavaScript event handlers needed --&gt;</code></pre>
            </div>

            <div class="code-section">
              <h6>Django Views (Python)</h6>
              <pre><code class="language-python">@require_http_methods(["POST"])
def task_create_htmx(request):
    """HTMX endpoint - returns task HTML."""
    title = request.POST.get("title", "").strip()
    
    task = Task.objects.create(title=title, completed=False)
    
    # Return HTML fragment
    return render(request, "examples/partials/task_item.html", {"task": task})

@require_http_methods(["DELETE"])
def task_delete_htmx(request, task_id):
    """Delete task - return empty to remove from DOM."""
    task = get_object_or_404(Task, id=task_id)
    task.delete()
    return HttpResponse("")  # Empty response = remove element

@require_http_methods(["POST"])
def task_toggle_htmx(request, task_id):
    """Toggle task - return updated HTML."""
    task = get_object_or_404(Task, id=task_id)
    task.completed = not task.completed
    task.save()
    
    # Return updated task HTML
    return render(request, "examples/partials/task_item.html", {"task": task})

# Key differences:
# - Returns HTML, not JSON
# - Server handles state changes
# - Partial templates reused for all operations</code></pre>
            </div>

            <div class="alert alert-success">
              <strong>Total Lines:</strong> ~18 lines (HTML) + 0 lines (JS) = <strong>~18 lines</strong>
              <br><strong>Code Reduction:</strong> 74% less code!
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="callout callout-info mt-3">
    <strong>Key Differences:</strong>
    <ul class="mb-0">
      <li><strong>jQuery:</strong> Manual CRUD operations, DOM element creation, and event delegation (~70 lines)</li>
      <li><strong>HTMX:</strong> Server returns HTML fragments; HTMX handles insertion and removal automatically (~18 lines)</li>
      <li><strong>Event Handling:</strong> jQuery uses event delegation; HTMX attributes travel with the HTML</li>
      <li><strong>State Management:</strong> jQuery tracks everything in JS; HTMX lets the server handle state</li>
    </ul>
  </div>

  <div class="mt-4">
    <nav aria-label="Pattern navigation">
      <ul class="pagination justify-content-center">
        <li class="page-item">
          <a class="page-link" href="{% url 'examples:comparison_modal_dialogs' %}">Previous: Modal Dialogs</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="{% url 'examples:comparison' %}">All Patterns</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="{% url 'examples:comparison_dependent_dropdowns' %}">Next: Dependent Dropdowns</a>
        </li>
      </ul>
    </nav>
  </div>
{% endblock %}

{% block inline_javascript %}
  <!-- Prism.js for syntax highlighting -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

  <script>
    // Get CSRF token from the form (more reliable than cookie)
    function getCSRFToken() {
      // Try to get from hidden input first
      const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
      if (tokenInput) {
        return tokenInput.value;
      }
      // Fallback to cookie method
      const cookieValue = document.cookie
        .split('; ')
        .find(row => row.startsWith('csrftoken='))
        ?.split('=')[1];
      return cookieValue || '';
    }
    const csrftoken = getCSRFToken();
    console.log('CSRF Token:', csrftoken ? 'Found (' + csrftoken.length + ' chars)' : 'NOT FOUND');

    // jQuery: Dynamic List Operations
    $('#jquery-task-form').on('submit', function(e) {
      e.preventDefault();
      const title = $('#jquery-task-input').val();
      
      if (!title) return;
      
      $.ajax({
        url: '{% url "examples:task_create_ajax" %}',
        method: 'POST',
        data: { title: title },
        headers: {'X-CSRFToken': csrftoken},
        success: function(response) {
          const task = response.task;
          const html = '<div class="task-item" data-task-id="' + task.id + '">' +
            '<input type="checkbox" class="form-check-input task-checkbox" ' + (task.completed ? 'checked' : '') + '>' +
            '<div class="task-title">' + task.title + '</div>' +
            '<button class="btn btn-sm btn-danger task-delete">Delete</button>' +
            '</div>';
          $('#jquery-task-list').prepend(html);
          $('#jquery-task-input').val('');
        },
        error: function(xhr, status, error) {
          console.error('Error creating task:', error);
          console.error('Response:', xhr.responseText);
          alert('Error creating task: ' + error);
        }
      });
    });
    
    // Event delegation for dynamically added tasks
    $('#jquery-task-list').on('click', '.task-delete', function() {
      const taskItem = $(this).closest('.task-item');
      const taskId = taskItem.data('task-id');
      
      $.ajax({
        url: '/examples/api/tasks/' + taskId + '/delete/',
        method: 'DELETE',
        headers: {'X-CSRFToken': csrftoken},
        success: function() {
          taskItem.remove();
        },
        error: function(xhr, status, error) {
          console.error('Error deleting task:', error);
          alert('Error deleting task: ' + error);
        }
      });
    });
    
    $('#jquery-task-list').on('change', '.task-checkbox', function() {
      const taskItem = $(this).closest('.task-item');
      const taskId = taskItem.data('task-id');
      
      $.ajax({
        url: '/examples/api/tasks/' + taskId + '/toggle/',
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken},
        success: function(response) {
          if (response.task.completed) {
            taskItem.addClass('completed');
          } else {
            taskItem.removeClass('completed');
          }
        },
        error: function(xhr, status, error) {
          console.error('Error toggling task:', error);
          alert('Error toggling task: ' + error);
        }
      });
    });
  </script>
{% endblock %}
