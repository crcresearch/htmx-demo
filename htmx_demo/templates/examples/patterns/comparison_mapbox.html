{% extends "base.html" %}
{% load static %}

{% block title %}Interactive Maps (Leaflet) - jQuery vs HTMX{% endblock %}

{% block css %}
  {{ block.super }}
  <link href="{% static 'css/examples.css' %}" rel="stylesheet">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
  <!-- Prism.js for syntax highlighting -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
  <style>
    /* Constrain comparison columns to 50% width */
    .comparison-side {
      min-width: 0;
      overflow: hidden;
    }
    .code-tab {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 1rem;
      margin-top: 1rem;
      max-height: 500px;
      overflow-y: auto;
    }
    .code-tab pre {
      margin: 0;
      border-radius: 0.375rem;
      margin-bottom: 0;
      overflow-x: auto;
      width: 100%;
    }
    .code-tab pre[class*="language-"] {
      margin: 0;
      border-radius: 0.375rem;
      background: #2d2d2d;
      overflow-x: auto;
      width: 100%;
    }
    .code-tab code {
      white-space: pre;
      display: block;
    }
    .code-section {
      margin-bottom: 1.5rem;
    }
    .code-section h6 {
      color: #495057;
      font-weight: 600;
      margin-bottom: 0.5rem;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 0.25rem;
    }
    
    /* Map containers */
    .map-container {
      width: 100%;
      height: 400px;
      border-radius: 0.375rem;
      overflow: hidden;
      margin-bottom: 1rem;
      border: 1px solid #dee2e6;
    }
    
    .filter-form {
      background: #f8f9fa;
      padding: 1rem;
      border-radius: 0.375rem;
      margin-bottom: 1rem;
    }
    
    .leaflet-popup-content {
      margin: 10px;
      max-width: 250px;
    }
    
    .popup-content h6 {
      margin: 0 0 5px 0;
      font-size: 14px;
      font-weight: bold;
    }
    
    .popup-content .badge {
      font-size: 10px;
      margin-right: 3px;
    }
    
    .location-data {
      display: none;
    }
    
    /* Leaflet marker colors by category */
    .leaflet-marker-icon.restaurant { filter: hue-rotate(0deg); }
    .leaflet-marker-icon.hotel { filter: hue-rotate(200deg); }
    .leaflet-marker-icon.museum { filter: hue-rotate(280deg); }
    .leaflet-marker-icon.park { filter: hue-rotate(120deg); }
    .leaflet-marker-icon.shopping { filter: hue-rotate(40deg); }
    .leaflet-marker-icon.office { filter: hue-rotate(180deg); }
  </style>
{% endblock %}

{% block content %}
  <div class="examples-nav">
    <ul class="nav nav-pills">
      <li class="nav-item">
        <a class="nav-link" href="{% url 'examples:index' %}">Home</a>
      </li>
      <li class="nav-item">
        <a class="nav-link active" href="{% url 'examples:comparison' %}">Side-by-Side Comparison</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="{% url 'examples:htmx_deep_dive' %}">HTMX Deep Dive</a>
      </li>
    </ul>
  </div>

  <nav aria-label="breadcrumb">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="{% url 'examples:comparison' %}">Comparison</a></li>
      <li class="breadcrumb-item active">Interactive Maps</li>
    </ol>
  </nav>

  <h1 class="mb-4">Pattern 8: Interactive Maps (Leaflet)</h1>
  
  <div class="alert alert-info">
    <strong>Scenario:</strong> Interactive map showing locations with dynamic filtering by category, rating, and price.
    <br><strong>Try it:</strong> Use the filters to update the map markers in real-time. Click markers for details.
    <br><strong>Compare:</strong> Switch to the "Code" tab to see implementation differences.
    <br><strong>Note:</strong> This demo uses Leaflet.js with free OpenStreetMap tiles - no API token required!
  </div>

  <div class="comparison-container">
    <!-- jQuery Implementation -->
    <div class="comparison-side">
      <h4>
        jQuery/AJAX
        <span class="tech-badge jquery">jQuery</span>
      </h4>

      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#jquery-interface" type="button">
            Interface
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#jquery-code" type="button">
            Code
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- jQuery Interface Tab -->
        <div class="tab-pane fade show active" id="jquery-interface">
          <div class="mt-3">
            <div class="filter-form">
              <h6>Filter Locations</h6>
              <div class="row g-2">
                <div class="col-md-4">
                  <label for="jquery-category" class="form-label">Category</label>
                  <select id="jquery-category" class="form-select form-select-sm">
                    <option value="">All Categories</option>
                    <option value="restaurant">Restaurant</option>
                    <option value="hotel">Hotel</option>
                    <option value="museum">Museum</option>
                    <option value="park">Park</option>
                    <option value="shopping">Shopping</option>
                    <option value="office">Office</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="jquery-rating" class="form-label">Min Rating</label>
                  <select id="jquery-rating" class="form-select form-select-sm">
                    <option value="">Any Rating</option>
                    <option value="3.0">3+ Stars</option>
                    <option value="4.0">4+ Stars</option>
                    <option value="4.5">4.5+ Stars</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="jquery-price" class="form-label">Price Range</label>
                  <select id="jquery-price" class="form-select form-select-sm">
                    <option value="">Any Price</option>
                    <option value="$">$ (Budget)</option>
                    <option value="$$">$$ (Moderate)</option>
                    <option value="$$$">$$$ (Expensive)</option>
                    <option value="$$$$">$$$$ (Very Expensive)</option>
                  </select>
                </div>
              </div>
            </div>
            
            <div id="jquery-map" class="map-container"></div>
            <div id="jquery-location-count" class="text-muted small"></div>
          </div>
        </div>

        <!-- jQuery Code Tab -->
        <div class="tab-pane fade" id="jquery-code">
          <div class="code-tab">
            <div class="code-section">
              <h6>HTML Template</h6>
              <pre><code class="language-markup">&lt;div class="filter-form"&gt;
  &lt;select id="jquery-category" class="form-select"&gt;
    &lt;option value=""&gt;All Categories&lt;/option&gt;
    &lt;option value="restaurant"&gt;Restaurant&lt;/option&gt;
    &lt;!-- more options --&gt;
  &lt;/select&gt;
  &lt;select id="jquery-rating" class="form-select"&gt;...&lt;/select&gt;
  &lt;select id="jquery-price" class="form-select"&gt;...&lt;/select&gt;
&lt;/div&gt;

&lt;div id="jquery-map" class="map-container"&gt;&lt;/div&gt;</code></pre>
            </div>

            <div class="code-section">
              <h6>JavaScript (jQuery + Leaflet)</h6>
              <pre><code class="language-javascript">// Initialize Leaflet map (no API token needed!)
const jqueryMap = L.map('jquery-map').setView([37.7749, -122.4194], 12);

// Add free OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(jqueryMap);

// Store markers globally
let jqueryMarkers = [];

// Function to load and display locations
function loadJQueryLocations() {
  const category = $('#jquery-category').val();
  const rating = $('#jquery-rating').val();
  const price = $('#jquery-price').val();
  
  $.ajax({
    url: '/examples/api/locations/search/',
    data: { category, min_rating: rating, price_range: price },
    success: function(response) {
      // Clear existing markers
      jqueryMarkers.forEach(marker => jqueryMap.removeLayer(marker));
      jqueryMarkers = [];
      
      // Create new markers from JSON data
      response.locations.forEach(function(loc) {
        // Create popup HTML manually
        const popupHTML = 
          '&lt;div class="popup-content"&gt;' +
          '&lt;h6&gt;' + loc.name + '&lt;/h6&gt;' +
          '&lt;small&gt;' + loc.address + '&lt;/small&gt;&lt;br&gt;' +
          '&lt;span class="badge bg-primary"&gt;' + loc.category + '&lt;/span&gt; ' +
          '&lt;span class="badge bg-warning"&gt;' + loc.rating + ' ⭐&lt;/span&gt; ' +
          '&lt;span class="badge bg-success"&gt;' + loc.price_range + '&lt;/span&gt;' +
          '&lt;/div&gt;';
        
        // Create marker
        const marker = L.marker([loc.latitude, loc.longitude])
          .bindPopup(popupHTML)
          .addTo(jqueryMap);
        
        jqueryMarkers.push(marker);
      });
      
      // Update count
      $('#jquery-location-count').text(
        response.count + ' location(s) found'
      );
    }
  });
}

// Attach change handlers to filters
$('#jquery-category, #jquery-rating, #jquery-price')
  .on('change', loadJQueryLocations);

// Initial load
loadJQueryLocations();

// Key challenges:
// 1. Manual map initialization and state management
// 2. Global marker array tracking
// 3. Manual marker cleanup on updates
// 4. Building popup HTML from JSON data
// 5. Complex event handler coordination
// 6. No server-side HTML rendering</code></pre>
            </div>

            <div class="code-section">
              <h6>Django View (Python)</h6>
              <pre><code class="language-python">def locations_search_ajax(request):
    """jQuery AJAX endpoint - returns JSON location data."""
    category = request.GET.get("category", "")
    min_rating = request.GET.get("min_rating", "")
    price_range = request.GET.get("price_range", "")
    
    locations = Location.objects.all()
    
    if category:
        locations = locations.filter(category=category)
    if min_rating:
        locations = locations.filter(rating__gte=float(min_rating))
    if price_range:
        locations = locations.filter(price_range=price_range)
    
    data = {
        "locations": [
            {
                "id": loc.id,
                "name": loc.name,
                "address": loc.address,
                "latitude": float(loc.latitude),
                "longitude": float(loc.longitude),
                "category": loc.category,
                "description": loc.description,
                "rating": float(loc.rating),
                "price_range": loc.price_range,
            }
            for loc in locations
        ],
        "count": locations.count(),
    }
    
    return JsonResponse(data)</code></pre>
            </div>

            <div class="alert alert-warning">
              <strong>Total Lines:</strong> ~20 lines (HTML) + ~60 lines (JS) = <strong>~80 lines</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- HTMX Implementation -->
    <div class="comparison-side">
      <h4>
        HTMX
        <span class="tech-badge htmx">HTMX</span>
      </h4>

      <ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
          <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#htmx-interface" type="button">
            Interface
          </button>
        </li>
        <li class="nav-item">
          <button class="nav-link" data-bs-toggle="tab" data-bs-target="#htmx-code" type="button">
            Code
          </button>
        </li>
      </ul>

      <div class="tab-content">
        <!-- HTMX Interface Tab -->
        <div class="tab-pane fade show active" id="htmx-interface">
          <div class="mt-3">
            <form id="htmx-filter-form" class="filter-form">
              <h6>Filter Locations</h6>
              <div class="row g-2">
                <div class="col-md-4">
                  <label for="htmx-category" class="form-label">Category</label>
                  <select id="htmx-category" name="category" class="form-select form-select-sm"
                          hx-get="{% url 'examples:locations_search_htmx' %}"
                          hx-trigger="change"
                          hx-target="#htmx-locations"
                          hx-include="[name='min_rating'], [name='price_range']">
                    <option value="">All Categories</option>
                    <option value="restaurant">Restaurant</option>
                    <option value="hotel">Hotel</option>
                    <option value="museum">Museum</option>
                    <option value="park">Park</option>
                    <option value="shopping">Shopping</option>
                    <option value="office">Office</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="htmx-rating" class="form-label">Min Rating</label>
                  <select id="htmx-rating" name="min_rating" class="form-select form-select-sm"
                          hx-get="{% url 'examples:locations_search_htmx' %}"
                          hx-trigger="change"
                          hx-target="#htmx-locations"
                          hx-include="[name='category'], [name='price_range']">
                    <option value="">Any Rating</option>
                    <option value="3.0">3+ Stars</option>
                    <option value="4.0">4+ Stars</option>
                    <option value="4.5">4.5+ Stars</option>
                  </select>
                </div>
                <div class="col-md-4">
                  <label for="htmx-price" class="form-label">Price Range</label>
                  <select id="htmx-price" name="price_range" class="form-select form-select-sm"
                          hx-get="{% url 'examples:locations_search_htmx' %}"
                          hx-trigger="change"
                          hx-target="#htmx-locations"
                          hx-include="[name='category'], [name='min_rating']">
                    <option value="">Any Price</option>
                    <option value="$">$ (Budget)</option>
                    <option value="$$">$$ (Moderate)</option>
                    <option value="$$$">$$$ (Expensive)</option>
                    <option value="$$$$">$$$$ (Very Expensive)</option>
                  </select>
                </div>
              </div>
            </form>
            
            <div id="htmx-map" class="map-container"></div>
            
            <!-- Location data container (hidden, populated by HTMX) -->
            <div id="htmx-locations" 
                 hx-get="{% url 'examples:locations_search_htmx' %}"
                 hx-trigger="load"
                 hx-swap="innerHTML">
              <!-- Markers data loaded here -->
            </div>
            
            <div id="htmx-location-count" class="text-muted small"></div>
          </div>
        </div>

        <!-- HTMX Code Tab -->
        <div class="tab-pane fade" id="htmx-code">
          <div class="code-tab">
            <div class="code-section">
              <h6>HTML Template (with HTMX attributes)</h6>
              <pre><code class="language-markup">&lt;form id="htmx-filter-form" class="filter-form"&gt;
  &lt;select name="category" class="form-select"
          hx-get="{% templatetag openblock %} url 'examples:locations_search_htmx' {% templatetag closeblock %}"
          hx-trigger="change"
          hx-target="#htmx-locations"
          hx-include="[name='min_rating'], [name='price_range']"&gt;
    &lt;option value=""&gt;All Categories&lt;/option&gt;
    &lt;option value="restaurant"&gt;Restaurant&lt;/option&gt;
    &lt;!-- more options --&gt;
  &lt;/select&gt;
  &lt;!-- Similar for rating and price --&gt;
&lt;/form&gt;

&lt;div id="htmx-map" class="map-container"&gt;&lt;/div&gt;

&lt;!-- Hidden container for location data --&gt;
&lt;div id="htmx-locations"
     hx-get="{% templatetag openblock %} url 'examples:locations_search_htmx' {% templatetag closeblock %}"
     hx-trigger="load"
     hx-swap="innerHTML"&gt;
&lt;/div&gt;

&lt;!-- How it works: --&gt;
&lt;!-- 1. HTMX loads location data as HTML --&gt;
&lt;!-- 2. JavaScript watches for DOM changes --&gt;
&lt;!-- 3. Map updates automatically --&gt;
&lt;!-- 4. No manual state management! --&gt;</code></pre>
            </div>

            <div class="code-section">
              <h6>Server Response (Partial Template)</h6>
              <pre><code class="language-markup">&lt;!-- location_markers.html --&gt;
{% templatetag openblock %} for location in locations {% templatetag closeblock %}
&lt;div class="location-data" 
     data-id="{% templatetag openvariable %} location.id {% templatetag closevariable %}"
     data-lat="{% templatetag openvariable %} location.latitude {% templatetag closevariable %}"
     data-lng="{% templatetag openvariable %} location.longitude {% templatetag closevariable %}"
     data-name="{% templatetag openvariable %} location.name {% templatetag closevariable %}"
     data-address="{% templatetag openvariable %} location.address {% templatetag closevariable %}"
     data-category="{% templatetag openvariable %} location.category {% templatetag closevariable %}"
     data-rating="{% templatetag openvariable %} location.rating {% templatetag closevariable %}"
     data-price="{% templatetag openvariable %} location.price_range {% templatetag closevariable %}"&gt;
&lt;/div&gt;
{% templatetag openblock %} endfor {% templatetag closeblock %}

&lt;!-- Server renders HTML with data attributes --&gt;
&lt;!-- Simple JS reads these and updates map --&gt;
&lt;!-- No JSON parsing needed! --&gt;</code></pre>
            </div>

            <div class="code-section">
              <h6>JavaScript (Minimal - Just Map Updates)</h6>
              <pre><code class="language-javascript">// Initialize Leaflet map (no API token needed!)
const htmxMap = L.map('htmx-map').setView([37.7749, -122.4194], 12);

// Add free OpenStreetMap tiles
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '© OpenStreetMap contributors'
}).addTo(htmxMap);

let htmxMarkers = [];

// Watch for HTMX updates
document.body.addEventListener('htmx:afterSwap', function(evt) {
  if (evt.detail.target.id === 'htmx-locations') {
    updateHtmxMap();
  }
});

// Update map from DOM data
function updateHtmxMap() {
  // Clear markers
  htmxMarkers.forEach(m => htmxMap.removeLayer(m));
  htmxMarkers = [];
  
  // Read location data from DOM
  const locations = document.querySelectorAll('.location-data');
  
  locations.forEach(function(loc) {
    const popupHTML = 
      '&lt;div class="popup-content"&gt;' +
      '&lt;h6&gt;' + loc.dataset.name + '&lt;/h6&gt;' +
      '&lt;small&gt;' + loc.dataset.address + '&lt;/small&gt;&lt;br&gt;' +
      '&lt;span class="badge bg-primary"&gt;' + loc.dataset.category + '&lt;/span&gt; ' +
      '&lt;span class="badge bg-warning"&gt;' + loc.dataset.rating + ' ⭐&lt;/span&gt; ' +
      '&lt;span class="badge bg-success"&gt;' + loc.dataset.price + '&lt;/span&gt;' +
      '&lt;/div&gt;';
    
    const marker = L.marker([parseFloat(loc.dataset.lat), parseFloat(loc.dataset.lng)])
      .bindPopup(popupHTML)
      .addTo(htmxMap);
    
    htmxMarkers.push(marker);
  });
  
  $('#htmx-location-count').text(locations.length + ' location(s) found');
}

// Initial load (small delay for HTMX to load data)
setTimeout(updateHtmxMap, 500);</code></pre>
            </div>

            <div class="code-section">
              <h6>Django View (Python)</h6>
              <pre><code class="language-python">def locations_search_htmx(request):
    """HTMX endpoint - returns HTML fragment with location data."""
    category = request.GET.get("category", "")
    min_rating = request.GET.get("min_rating", "")
    price_range = request.GET.get("price_range", "")
    
    locations = Location.objects.all()
    
    if category:
        locations = locations.filter(category=category)
    if min_rating:
        locations = locations.filter(rating__gte=float(min_rating))
    if price_range:
        locations = locations.filter(price_range=price_range)
    
    # Return HTML fragment with data attributes
    return render(
        request,
        "examples/partials/location_markers.html",
        {"locations": locations}
    )

# Key differences:
# - Returns HTML, not JSON
# - Server handles all data formatting
# - No complex client-side data transformation
# - HTMX coordinates form inputs automatically</code></pre>
            </div>

            <div class="alert alert-success">
              <strong>Total Lines:</strong> ~25 lines (HTML) + ~35 lines (JS) = <strong>~60 lines</strong>
              <br><strong>Code Reduction:</strong> 25% less code + cleaner separation of concerns!
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="callout callout-info mt-3">
    <strong>Key Differences:</strong>
    <ul class="mb-0">
      <li><strong>jQuery:</strong> Manual AJAX calls, JSON parsing, marker management, popup HTML building (~80 lines)</li>
      <li><strong>HTMX:</strong> Declarative attributes, server-rendered HTML with data attributes, event-driven map updates (~60 lines)</li>
      <li><strong>Filter Coordination:</strong> jQuery needs manual event binding; HTMX uses <code>hx-include</code> for automatic coordination</li>
      <li><strong>Data Format:</strong> jQuery builds HTML from JSON; HTMX receives HTML from server</li>
      <li><strong>State Management:</strong> jQuery tracks everything in JS; HTMX lets server handle filtering logic</li>
      <li><strong>Hybrid Approach:</strong> HTMX handles data loading, Leaflet handles visualization - best of both worlds!</li>
    </ul>
  </div>

  <div class="mt-4">
    <nav aria-label="Pattern navigation">
      <ul class="pagination justify-content-center">
        <li class="page-item">
          <a class="page-link" href="{% url 'examples:comparison_polling' %}">Previous: Polling</a>
        </li>
        <li class="page-item">
          <a class="page-link" href="{% url 'examples:comparison' %}">All Patterns</a>
        </li>
        <li class="page-item disabled">
          <span class="page-link">Next</span>
        </li>
      </ul>
    </nav>
  </div>
{% endblock %}

{% block inline_javascript %}
  <!-- Leaflet JS (no API token required!) -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          crossorigin=""></script>
  
  <!-- Prism.js for syntax highlighting -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>

  <script>
    // ============================================================================
    // jQuery Implementation
    // ============================================================================
    
    // Initialize Leaflet map (no API token needed!)
    const jqueryMap = L.map('jquery-map').setView([37.7749, -122.4194], 12);
    
    // Add free OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(jqueryMap);

    let jqueryMarkers = [];

    function loadJQueryLocations() {
      const category = $('#jquery-category').val();
      const rating = $('#jquery-rating').val();
      const price = $('#jquery-price').val();
      
      $.ajax({
        url: '{% url "examples:locations_search_ajax" %}',
        data: { 
          category: category, 
          min_rating: rating, 
          price_range: price 
        },
        success: function(response) {
          // Clear existing markers
          jqueryMarkers.forEach(marker => jqueryMap.removeLayer(marker));
          jqueryMarkers = [];
          
          // Create new markers
          response.locations.forEach(function(loc) {
            const popupHTML = 
              '<div class="popup-content">' +
              '<h6>' + loc.name + '</h6>' +
              '<small>' + loc.address + '</small><br>' +
              '<span class="badge bg-primary">' + loc.category + '</span> ' +
              '<span class="badge bg-warning">' + loc.rating + ' ⭐</span> ' +
              '<span class="badge bg-success">' + loc.price_range + '</span>' +
              '</div>';
            
            const marker = L.marker([loc.latitude, loc.longitude])
              .bindPopup(popupHTML)
              .addTo(jqueryMap);
            
            jqueryMarkers.push(marker);
          });
          
          $('#jquery-location-count').text(response.count + ' location(s) found');
        }
      });
    }

    // Attach change handlers
    $('#jquery-category, #jquery-rating, #jquery-price').on('change', loadJQueryLocations);
    
    // Initial load
    loadJQueryLocations();

    // ============================================================================
    // HTMX Implementation
    // ============================================================================
    
    // Initialize Leaflet map (no API token needed!)
    const htmxMap = L.map('htmx-map').setView([37.7749, -122.4194], 12);
    
    // Add free OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(htmxMap);

    let htmxMarkers = [];

    // Listen for HTMX updates
    document.body.addEventListener('htmx:afterSwap', function(evt) {
      if (evt.detail.target.id === 'htmx-locations') {
        updateHtmxMap();
      }
    });

    function updateHtmxMap() {
      // Clear existing markers
      htmxMarkers.forEach(marker => htmxMap.removeLayer(marker));
      htmxMarkers = [];
      
      // Read location data from DOM
      const locations = document.querySelectorAll('#htmx-locations .location-data');
      
      locations.forEach(function(loc) {
        const popupHTML = 
          '<div class="popup-content">' +
          '<h6>' + loc.dataset.name + '</h6>' +
          '<small>' + loc.dataset.address + '</small><br>' +
          '<span class="badge bg-primary">' + loc.dataset.category + '</span> ' +
          '<span class="badge bg-warning">' + loc.dataset.rating + ' ⭐</span> ' +
          '<span class="badge bg-success">' + loc.dataset.price + '</span>' +
          '</div>';
        
        const marker = L.marker([parseFloat(loc.dataset.lat), parseFloat(loc.dataset.lng)])
          .bindPopup(popupHTML)
          .addTo(htmxMap);
        
        htmxMarkers.push(marker);
      });
      
      $('#htmx-location-count').text(locations.length + ' location(s) found');
    }

    // Initial load (small delay to ensure HTMX has loaded the initial data)
    setTimeout(updateHtmxMap, 500);
  </script>
{% endblock %}

